<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo Lists - Auth & Realtime</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Auth Screen */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

            .auth-container h1 {
                color: #333;
                margin-bottom: 10px;
                text-align: center;
            }

        .auth-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

            .auth-tab.active {
                background: #667eea;
                color: white;
            }

        .auth-form {
            display: none;
        }

            .auth-form.active {
                display: block;
            }

        .form-group {
            margin-bottom: 20px;
        }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                color: #333;
                font-weight: 600;
            }

            .form-group input {
                width: 100%;
                padding: 12px;
                border: 2px solid #eee;
                border-radius: 6px;
                font-size: 16px;
            }

                .form-group input:focus {
                    outline: none;
                    border-color: #667eea;
                }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

            .auth-button:hover {
                background: #5568d3;
            }

            .auth-button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }

        /* Main App */
        .app-container {
            display: none;
        }

            .app-container.active {
                display: block;
            }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

            .header h1 {
                color: #333;
                font-size: 2rem;
            }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .username {
            color: #666;
            font-weight: 600;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

            .logout-btn:hover {
                background: #da190b;
            }

        /* Add List Section */
        .add-list-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .add-list-form {
            display: flex;
            gap: 10px;
        }

            .add-list-form input {
                flex: 1;
                padding: 15px;
                border: 2px solid #eee;
                border-radius: 8px;
                font-size: 16px;
            }

            .add-list-form button {
                padding: 15px 30px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 16px;
            }

        /* Lists Grid */
        .lists-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .list-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

            .list-card:hover {
                transform: translateY(-2px);
            }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .list-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .delete-list-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Items */
        .items-list {
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

            .item.completed .item-text {
                text-decoration: line-through;
                color: #999;
            }

        .item-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }

        .item-text {
            flex: 1;
            color: #333;
        }

        .delete-item-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Add Item Form */
        .add-item-form {
            display: flex;
            gap: 8px;
        }

            .add-item-form input {
                flex: 1;
                padding: 10px;
                border: 2px solid #eee;
                border-radius: 6px;
                font-size: 14px;
            }

            .add-item-form button {
                padding: 10px 20px;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
            }

        /* Error/Success Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

            .message.show {
                display: block;
            }

            .message.error {
                background: #f44336;
                color: white;
            }

            .message.success {
                background: #4CAF50;
                color: white;
            }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Realtime Indicator */
        .realtime-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            margin-right: 5px;
        }

            .realtime-status.disconnected {
                background: #f44336;
            }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div class="loading" id="loading">Loading...</div>

    <!-- Auth Screen -->
    <div class="auth-container" id="authContainer">
        <h1>📝 Todo Lists</h1>
        <p class="auth-subtitle">Sign in or create an account</p>

        <div class="message" id="authMessage"></div>

        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchTab('login')">Login</button>
            <button class="auth-tab" onclick="switchTab('signup')">Sign Up</button>
        </div>

        <!-- Login Form -->
        <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="loginUsername" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="auth-button">Login</button>
        </form>

        <!-- Signup Form -->
        <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="signupUsername" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signupEmail" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signupPassword" required minlength="6">
            </div>
            <button type="submit" class="auth-button">Create Account</button>
        </form>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>📝 My Todo Lists</h1>
                <div class="user-info">
                    <span class="realtime-status" id="realtimeStatus"></span>
                    <span class="username" id="username"></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="message" id="appMessage"></div>

            <!-- Add List Section -->
            <div class="add-list-section">
                <h3 style="margin-bottom: 15px; color: #333;">Create New List</h3>
                <div class="add-list-form">
                    <input type="text"
                           id="newListInput"
                           placeholder="List name (e.g., Work, Personal, Shopping...)"
                           onkeypress="if(event.key === 'Enter') createList()">
                    <button onclick="createList()">+ Add List</button>
                </div>
            </div>

            <!-- Lists Container -->
            <div class="lists-container" id="listsContainer">
                <div class="empty-state">No lists yet. Create one above! 🎉</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentUser = null;
        let authToken = null;
        let realtimeInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });

        // Check if user is already logged in
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');

            document.getElementById('loading').style.display = 'none';

            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showApp();
            } else {
                showAuth();
            }
        }

        // Switch between login/signup tabs
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            const forms = document.querySelectorAll('.auth-form');

            tabs.forEach(t => t.classList.remove('active'));
            forms.forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('signupForm').classList.add('active');
            }

            hideMessage('authMessage');
        }

        // Handle Login
        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Login failed');
                }

                // Save token
                authToken = data.access_token;
                localStorage.setItem('authToken', authToken);

                // Get user info
                await fetchCurrentUser();

                showMessage('authMessage', 'Login successful!', 'success');
                setTimeout(() => showApp(), 500);

            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        }

        // Handle Signup
        async function handleSignup(event) {
            event.preventDefault();

            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Signup failed');
                }

                showMessage('authMessage', 'Account created! Please login.', 'success');

                // Switch to login tab
                setTimeout(() => {
                    switchTab('login');
                    document.getElementById('loginUsername').value = username;
                }, 1500);

            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        }

        // Fetch current user info
        async function fetchCurrentUser() {
            try {
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Failed to fetch user');

                currentUser = await response.json();
                localStorage.setItem('user', JSON.stringify(currentUser));

            } catch (error) {
                console.error('Error fetching user:', error);
                logout();
            }
        }

        // Show app
        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('username').textContent = currentUser.username;

            loadLists();
            startRealtimePolling();
        }

        // Show auth
        function showAuth() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContainer').classList.remove('active');
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            authToken = null;
            currentUser = null;
            stopRealtimePolling();
            showAuth();
        }

        // API call with auth
        async function apiCall(url, options = {}) {
            const headers = {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            const response = await fetch(url, { ...options, headers });

            // If unauthorized, logout
            if (response.status === 401) {
                logout();
                throw new Error('Session expired. Please login again.');
            }

            return response;
        }

        // Load lists
        async function loadLists() {
            try {
                const response = await apiCall(`${API_URL}/lists/`);
                if (!response.ok) throw new Error('Failed to load lists');

                const lists = await response.json();
                displayLists(lists);

            } catch (error) {
                showMessage('appMessage', error.message, 'error');
            }
        }

        // Display lists
        function displayLists(lists) {
            const container = document.getElementById('listsContainer');

            if (lists.length === 0) {
                container.innerHTML = '<div class="empty-state">No lists yet. Create one above! 🎉</div>';
                return;
            }

            container.innerHTML = lists.map(list => `
                    <div class="list-card" data-list-id="${list.id}">
                        <div class="list-header">
                            <div class="list-title">${escapeHtml(list.title)}</div>
                            <button class="delete-list-btn" onclick="deleteList(${list.id})">Delete</button>
                        </div>

                        <div class="items-list">
                            ${list.items && list.items.length > 0 ?
                    list.items.map(item => `
                                    <div class="item ${item.completed ? 'completed' : ''}" data-item-id="${item.id}">
                                        <input
                                            type="checkbox"
                                            class="item-checkbox"
                                            ${item.completed ? 'checked' : ''}
                                            onchange="toggleItem(${item.id}, ${!item.completed})"
                                        >
                                        <span class="item-text">${escapeHtml(item.title)}</span>
                                        <button class="delete-item-btn" onclick="deleteItem(${item.id})">×</button>
                                    </div>
                                `).join('') :
                    '<div class="empty-state" style="padding: 20px;">No items yet</div>'
                }
                        </div>

                        <div class="add-item-form">
                            <input
                                type="text"
                                placeholder="Add new item..."
                                id="itemInput${list.id}"
                                onkeypress="if(event.key === 'Enter') addItem(${list.id})"
                            >
                            <button onclick="addItem(${list.id})">Add</button>
                        </div>
                    </div>
                `).join('');
        }

        // Create list
        async function createList() {
            const input = document.getElementById('newListInput');
            const name = input.value.trim();

            if (!name) {
                showMessage('appMessage', 'Please enter a list name', 'error');
                return;
            }

            try {
                const response = await apiCall(`${API_URL}/lists/`, {
                    method: 'POST',
                    body: JSON.stringify({ name })
                });

                if (!response.ok) throw new Error('Failed to create list');

                input.value = '';
                await loadLists();

            } catch (error) {
                showMessage('appMessage', error.message, 'error');
            }
        }

        // Delete list
        async function deleteList(listId) {
            if (!confirm('Delete this list and all its items?')) return;

            try {
                const response = await apiCall(`${API_URL}/lists/${listId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete list');

                await loadLists();

            } catch (error) {
                showMessage('appMessage', error.message, 'error');
            }
        }

        // Add item
        async function addItem(listId) {
            const input = document.getElementById(`itemInput${listId}`);
            const title = input.value.trim();

            if (!title) return;

            try {
                const response = await apiCall(`${API_URL}/lists/${listId}/items/`, {
                    method: 'POST',
                    body: JSON.stringify({ title, completed: false })
                });

                if (!response.ok) throw new Error('Failed to add item');

                input.value = '';
                await loadLists();

            } catch (error) {
                showMessage('appMessage', error.message, 'error');
            }
        }

        // Toggle item
        async function toggleItem(itemId, completed) {
            try {
                const response = await apiCall(`${API_URL}/items/${itemId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ completed })
                });

                if (!response.ok) throw new Error('Failed to update item');

                await loadLists();

            } catch (error) {
                showMessage('appMessage', error.message, 'error');
            }
        }

        // Delete item
        async function deleteItem(itemId) {
            try {
                const response = await apiCall(`${API_URL}/items/${itemId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete item');

                await loadLists();

            } catch (error) {
                showMessage('appMessage', error.message, 'error');
            }
        }

        // Realtime polling (simple implementation)
        function startRealtimePolling() {
            // Poll for updates every 3 seconds
            realtimeInterval = setInterval(() => {
                if (authToken && currentUser) {
                    loadLists();
                    document.getElementById('realtimeStatus').classList.remove('disconnected');
                }
            }, 3000);
        }

        function stopRealtimePolling() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
            }
        }

        // Utility functions
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `message ${type} show`;
            setTimeout(() => hideMessage(elementId), 5000);
        }

        function hideMessage(elementId) {
            document.getElementById(elementId).classList.remove('show');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>